---
title: 计算机网络原理之【五层协议】
categories:
- 网络原理
tags:
- 网络原理
---

![](/images/网络中五层协议.png)

网络协议是每个工程师必须要掌握的知识。

<!--more-->



## 从底层到高层看网络协议（从下到上）

#### **一、物理层**

1、物理层通过物理手段将电脑连接起来，主要负传送 0 ，1 信号来通信。但是单纯的 0 1 没有任何意义，也没有规定怎么结合，那么有了链路层。

#### 二、**链路层**

2、链路层诞生意味着通过规定的“以太网”协议规定的电信号的分组形式，不同分组代表不同的信息，双方通信都可以识别这些信息。发送方和接受方怎么确定对方是谁的？（要有个标识才行）

3、每台计算机都要有“网卡”，数据包都是通过网卡传输的，每个网卡都有一个地址，叫做 MAC 地址（每台计算机一出生在厂商就确定的），也就明确了数据包的发送地址和接收地址。有了标识了，发送方怎么才能知道接收方的 MAC 地址呢？（ARK协议）                                       

4 只能通过连接两个子网络的网关去处理；具体过程是：

- 首先判断两个设备是否在同一子网中，如果不在，发送方就将数据包发送到子网的网关，首先要通过 ARK 协议知道网关的 MAC 地址，然后该网关通过路由发送到接收方的网关，然后送达接收方。

如果在同一网络中，我们就通过 ARK 协议得到对方的 MAC 地址。因为每台设备都有一个 IP 地址，所以我们想着通过 IP 地址去确定对方的 MAC 地址。该发送方通过 ARP 协议广播的形式发送一个带有对方 IP 的数据包，子网中的每个计算机都收到了该数据包，就取出头部的IP地址信息对比，如果和自己的一样，接收方就给发送方报告自己的 MAC 地址，否则就丢弃这个包。通过 ARP 协议我们就知道了同一子网中的 MAC 地址，可随意发送信息。

既然知道了对方的 MAC 地址，怎么准确的将数据发送过去呢？

5、并不是我们所想的直接送达，而是通过广播的方式，向网络的所有计算机发送，让每台计算机通过读取数据包的标头看看和自己的 MAC 地址是否一样，如果一样就接受数据呗。

#### **三、网络层**

6、链路层的兄弟，每人都要送一个包，你这发送消息效率太低了，而且只能在一个子网络中发送，如果别人不在这个网络中是发送不出去的，太 Low，给我改进。

7、那行，我改，那找我路由朋友来帮忙，如果路由朋友来帮忙，如果两个计算机不在子网络中，那么让我朋友路由去发送，如果在同一子网络中，那么我自己来负责，省的整天给我瞎BB。

8、链路兄弟，两台计算机不在同一子网络中的通信你怎么甩给我了？真不够哥们，我只能通过 “网络地址” 来识别不同子网中的通信了。

9、网络地址需要有规矩，不能瞎规定，规定网络地址的协议叫做 IP 协议，定义的地址叫做 IP 地址。通常是由四段的十进制表示（32个二进制），从 0.0.0.0 到 255.255.255.255（每段由 8 位二进制组成 2^8）。

10、每台计算机都会分配一个 IP 地址，每个 IP 地址分为两部分，一部分是代表网络地址，另一部分代表主机地址。若网络部分地址相同，这两台计算机必处于同一子网中。那怎么区分这个IP的前多少位代表的是网络地址，后多少位代表的是主机地址呢？这个在 IP 地址上看不出来。

11、那么我们用另一个 32 位的二进制值来专门来代表。形式和 IP 地址的形式完全一样的，1 代表网络地址部分，0 代表主机部分（11111111.11111111.11111111.00000000 十进制为 255.255.255.0，前24位代表网络部分，后8位代表主机部分）

12、判断两个 IP 是否在同一网络中方法就是两个 IP 地址与子网掩码进行 AND 运算（两数为1，结果为1，其他为0）。最后的比较结果相同就处在同一子网络中。

13、当两台计算机不在同一子网时，就通过 IP 协议发送数据包了。IP 数据包要有 IP 地址的信息呀，那么就将 IP 数据包放到以太网数据包的数据部分，这样一来，就体现出了互联网分层的好处。上层变动，和上层变动没有什么太大关系。

**网络层的通信是主机到主机的通信。**

#### 四、**传输层**

14、虽然通过上述的 IP 地址和 MAC 地址可以进行通信了，但是计算机打开多个软件，怎么才能知道网络传来的信息那是哪个软件的？

15、那么我们就规定不同的程序数据要走不同的端口。**传输层的功能就是建立“端口到端口”的通信**。主机和端口确认了，就可以正常的进行通信了。

16、在数据包中加入端口信息，就需要新的协议，就用 UDP 协议来实现。将端口信息打包之后，将放入到 IP 数据包中。但是 UDP 简单，但是可靠性差，一旦发出数据包，无法知道对方是否收到？

17、那么具有验证功能的 UDP 协议 TCP 协议诞生了，TCP也是内嵌在 IP 数据包中的。每个发送的数据包都要确认一下对方是否收到，如果               收到没收到的确认，就重新发送该数据包，但是 TCP 的实现非常复杂。

#### 五、**应用层**

18、应用层主要对数据进行读取，因为数据包的数据来自有不同的程序，格式各不相同，所以要规定好格式再进行解读，否则无法解读。应用层的作用就是**规定应用程序的数据格式**。应用层规定格式的数据包在 TCP 数据包中。



## 从高层到底层看网络协议（从上到下）

#### 一、配置上网参数

- 本机 IP 地址
- 子网掩码
- 网关的 IP 地址
- DNS 的 IP 地址

1、计算机上网必须设置 IP 地址、子网掩码、网关地址以及 DNS，这样计算机每次开机都会设置这样的地址，这种地址叫做“静态IP地址“。不过有一个缺点，如果这台计算机不上网总是占用这个IP地址，所以必须设置动态获取IP。

2、每次开启计算机都要动态分配一个 IP 地址，所使用的协议为 DHCP 协议，在每一个子网络中都会有一台计算机专门负责分配 IP 地址，这个机器叫做“DHCP服务器”。

3、每次计算机开机，都会向 DHCP 服务器发送一个请求申请IP地址等信息。发送请求必须知道对方的IP地址和MAC地址，起初的两台计算机都没有设置，应该怎么办？

4、这时用到 DHCP 的巧妙设计，DHCP 是基于 UDP 协议的。因为发送方不知道对方的 MAC 地址，所以在数据包中设置 FF-FF-FF-FF-FF-FF，将其封装到以太网的数据包中。由于计算机也不知道自己的IP地址，所以发送方的 IP 地址为 0.0.0.0。DHCP 服务器的 IP 地址为255.255.255.255，将信息封装到 IP 头部。然后将端口号信息进行封装到 UDP 的头部，发送方的端口号为 68 端口，接收方的端口号为 67 端口。

5、发送方开始进行广播发送，子网络中的计算机接收到数据包，首先查看以太网数据包中的 MAC 地址为 FF-FF-FF-FF-FF-FF，不能确认是谁发送的数据，然后查看 IP 头部发现地址为 0.0.0.0，于是 DHCP 知道了这个包是给自己发的，其他计算机将会丢弃这个包。

6、然后 DHCP 服务器读取这个包的数据内容，分配好 IP 地址，然后发送回去一个 DHCP  响应，新加入的计算机接收到响应包之后，就会进行配置。

#### 二、网页请求过程

1、首先在浏览器输入一个域名，是没有 IP 地址的，先要将域名传到 DNS 服务器进行解析，DNS 服务器会返回一个锁清秋服务器的 IP 地址。

2、然后判断两个计算机是否在同一个子网络中，就会用到子网掩码，两台计算机的 IP 地址分别对子网掩码进行 AND 运算，发现不在同一子网络中，所以必须通过网关发送数据包，此时接受方的 MAC 地址是网关的 MAC 地址。

3、浏览网页所用的是 HTTP 协议，将其嵌入在 TCP 数据包中，TCP 数据包需要设置端口，将信息嵌入在 IP 数据包中，IP数据包需要设置双方的 IP 地址，然后将 IP 数据包嵌入在以太网的数据包中，以太网数据包需要设置双方的 MAC 地址，然后将数据包在网络中传输。

（**注意：**如果 IP 数据包过长，需要分割发送）

4、经过多个网关的转发，服务器收到数据包，将其多个数据包进行拼接，取出完整的 TCP 数据包，然后读出 HTTP 的请求，做出 HTTP 响应，然后再用 TCP 协议发回来。





### 一、网络层中协议

#### 1、五层模型

> 越最下层越靠近硬件，越最上方的层，越靠近用户。

- 应用层
- 传输层
- 网络层
- 数据链路层
- 物理层



#### 2、层与协议

> 互联网分为若干层，每一层都有特定的功能和规则。大家都要遵守的规则叫做 “协议”。每次层都有很多协议，总起来叫做“互联网协议”。



#### 3、物理层

> 物理层主要是通过光缆、电缆、双绞线、无线电波等方式把电脑连起来，它就是把电脑连接起来的物理手段。它主要规定了网络的一些电气特性，作用是**负责传送0和1的电信号。**



#### 4、链路层

###### ▉ 定义

> **问题**：单纯的 0 和 1 没有任何意义，必须规定解读方式：多少个电信号算一组？每个信号位有何意义？
>
> **解决：**这就是"链接层"的功能，它在"实体层"的上方，确定了0和1的分组方式。



###### ▉以太网协议（数据包的定义）

> **一组电信号**构成一个**数据包**，叫做"帧"（Frame）。每一帧分成两个部分：**标头（Head）和数据（Data）**。 

- **标头：**包含数据包的一些说明项，比如发送者、接受者、数据类型等等 。
- **数据： **数据包的具体内容 。



###### ▉MAC地址

> **问题**：发送者和接受者是如何标识呢？
>
> **解决：**以太网规定，连入网络的所有设备，都必须具有"**网卡**"接口。数据包必须是从一块网卡，传送到另一块网卡。网卡的地址，就是数据包的发送地址和接收地址，这叫做MAC地址。 



###### ▉广播

> **1、问题：**一块网卡怎么会知道另一块网卡的MAC地址？以太网数据包必须知道接收方的MAC地址，然后才能发送。 
>
> **解决：通过 ARP 协议知道对方的 MAC 地址。**
>
> 
>
> **2、问题：**知道MAC地址了，系统怎样才能把数据包准确送到接收方 ？
>
> **解决：**
>
> 发送方并不是准确的发送到接受方，而是向本网络内所有计算机发送，每台计算机判断是否接收？它们读取这个包的"标头"，找到接收方的 MAC 地址，然后与自身的 MAC 地址相比较，如果两者相同，就接受这个包，做进一步处理，否则就丢弃这个包。这种发送方式就叫做"广播"（broadcasting）。 



#### 5、网络层

###### ▉ 由来

> 上述虽然可以实现通信，存在一下弊端：
>
> 1）局限在发送者所在的子网络 。
>
> 2）以广播发送效率低下。
>
> 3）两台机器不在子网络。广播是传不过去的。



###### ▉ 网络层的定义

> **问题：**怎么做到如果是同一个子网络，就采用广播方式发送，否则就采用"路由"方式发送？
>
> **解决:** 这就导致了"网络层"的诞生。它的作用是引进一套新的地址，使得我们能够区分不同的计算机是否属于同一个子网络。**这套地址就叫做"网络地址"，简称"网址"**。



###### ▉ 网络地址和MAC地址的区别？

> 1、两种地址之间没有任何联系，MAC地址是绑定在网卡上的，网络地址则是管理员分配的，它们只是随机组合在一起。
>
> 2、网络在确定所在子网络的时候，先处理网络地址，然后在处理MAC地址。 



###### ▉ IP 协议

> **作用： **一个是为每一台计算机分配IP地址，另一个是确定哪些地址在同一个子网络。 
>
> **定义：**规定网络地址的协议，叫做IP协议。它所定义的地址，就被称 为IP地址。 
>
> **组成： **地址分成两个部分，前一部分代表**网络**，后一部分代表**主机 **。可以判断两台计算机是否处于同一网络中。



###### ▉ 子网掩码

> **问题： **对于 IP 地址无法判断网络部分，到底是前16位还是前24位代表网络地址？
>
> **解决：**子网掩码
>
> **组成: ** 它的网络部分全部为1，主机部分全部为0。 
>
> 比如，比如，IP地址172.16.254.1，如果已知网络部分是前24位，主机部分是后8位，那么子网络掩码就是11111111.11111111.11111111.00000000，写成十进制就是255.255.255.0。 



###### ▉ 判断是否处于同一网络

> 将两个IP地址与子网掩码分别进行**AND运算（**两个数位都为1，运算结果为1，否则为0），然后比较结果是否相同，如果是的话，就表明它们在同一个子网络中，否则就不是。 



###### ▉ IP 数据包

> 之前的以太网数据包只包含 MAC 地址，没有 IP 地址的栏位。并不需要添加 IP 栏位，我们直接将 IP 数据包添加到以太网数据包的数据部分。这就是互联网分层的好处，上层的变动完全不涉及下层的结构。



**IP 数据包：**

- 标头：包括版本、长度、IP地址等信息。
- 数据：IP 数据包的具体内容。



###### ▉ ARP 协议

> **问题：**IP 数据包是放在以太网数据包里发送的，所以同时知道 IP 地址和 MAC 地址，IP 地址是已知的，但是不知道 MAC 地址。我们需要从 IP 地址中的到 MAC 地址。
>
> **解决：**
>
> 两种情况：是否在同一子网络。
>
> 第一种情况，不在同一子网络，将数据包扔给两个子网络连接处网关处理。
>
> 第二种情况，同一子网络中，通过 ARP协议。ARP协议也是发出一个数据包（包含在以太网数据包中），其中包含它所要查询主机的IP地址，在对方的MAC地址这一栏，填的是FF:FF:FF:FF:FF:FF，表示这是一个"广播"地址。它所在子网络的每一台主机，都会收到这个数据包，从中取出IP地址，与自身的IP地址进行比较。如果两者相同，都做出回复，向对方报告自己的MAC地址，否则就丢弃这个包 。



#### 6、传输层

> **问题：**计算机很多程序同时运行，那一个数据包传过来怎么区分知道是哪个程序的内容呢？
>
> **解决：**提供一个参数，用来表示数据包对应的程序，这个参数叫做“端口（port）”。每个数据包发送到特定的端口，不同的程序就能取到自己所需要的数据。



###### ▉ 端口

> "端口"是0到65535之间的一个整数，正好16个二进制位。应用程序会随机选用一个端口，然后与服务器的相应端口联系。
>



###### ▉ 功能

> **"传输层"的功能，就是建立"端口到端口"的通信。相比之下，"网络层"的功能是建立"主机到主机"的通信。只要确定主机和端口，我们就能实现程序之间的交流。**



###### ▉ UDP 协议

> 在数据包中加入端口号，就实现了新的协议叫 UDP 协议。将数据包存放到 IP 数据包中。
>
> **优点：**比较简单，容易实现。
>
> **缺点：**可靠性较差，一旦数据包发出，无法知道对方是否收到。



###### ▉ TCP 协议

> 为了提高网络的可靠性，就诞生了新的协议叫做 TCP 协议（有确认机制的 UDP 协议）。将数据包存放到 IP 数据包中。
>
> 每发出一个数据包都要求确认。如果有一个数据包遗失，就收不到确认，发出方就知道有必要重发这个数据包了。
>
> 优点：可靠性好，稳定性好。
>
> 缺点：过程复杂、实现困难、消耗较多的资源。



#### 7、应用层

> 应用层接收到“传输层”的数据，然后进行读取数据。读取前必须规定好格式，否则无法读取。TCP 通过各种各样的程序传输数据，不同的协议规定了不同数据的格式，这些程序协议就构成了“应用层”。



###### ▉ 作用

> 规定应用程序的数据格式。

























