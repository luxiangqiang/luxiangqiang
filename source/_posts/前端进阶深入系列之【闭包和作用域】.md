---
title: 前端进阶深入系列之【闭包和作用域】
categories: 
- 前端
- javascript
- 前端深入系列
tags: 
- 前端
- javascript
- 前端深入系列
---

深入闭包以及闭包的应用！

<!--more-->



### 一、作用域

**1、作用域：**限定变量和函数的可用性的范围叫做**作用域**。

**2、作用域链：**保证对**执行函数**有权访问的所有变量和函数的**有序访问**。



### 二、理解闭包？

#### 1、什么是闭包？

> 闭包是在函数内可以访问并操作函数外部的变量。只要变量或函数存在于声明的函数的作用域内，闭包就可以使用函数访问到这些变量。



#### 2、如何理解闭包？

>  在外部函数声明内部函数的时候，就创建了一个闭包。闭包包含了当前声明的函数作用域中所有的函数和变量。只要声明的函数存在，当前闭包就会存在。



###### ▉ 注意一：

> 每一个通过闭包访问变量的函数都具有一个作用域链，作用域链包含闭包的全部信息。



###### ▉ 注意二：

> 闭包不能过度使用，因为闭包所有的变量都存在内存中，直到不会被使用到（页面卸载）时才会被垃圾回收，多度的使用闭包会影响性能。



### 三、闭包的应用

#### 1、应用一：封装私有变量

> 由于原生的 JavaScript 不支持私有变量，所以只能通过闭包的方式来实现。

- 在构造函数中的外部是无法访问到函数内部的变量的，只能通过闭包的形式访问内部的变量。

- 通过 new 的方式创建一个新对象，改变函数内 this 的指向，为实例对象添加新属性，返回一个新对象，通过对象的方式可以访问到构造函数内部的属性。
- 通过闭包内部的方法获取到私有变量的值，但是不能直接进行访问私有变量，有效的阻止了对变量不可控的修改。



#### 2、应用二：回调函数

> 由于处理回调函数是一种异步的调用函数，需要在回调函数中频繁的访问外部的数据，所以用闭包来解决这个问题。

- 闭包解决问题回调可以有效的防止污染全局变量。当不使用闭包的时候，所有的变量全部都在全局作用域下，多个异步操作同时对变量进行读或取，那么就会发生冲突，就污染到了全局的作用域。

- 如果没有闭包，一次性做许多事情就会变得非常的困难，例如：事件绑定、动画甚至服务器请求。

- 闭包不是存在于创建的那一时刻，而是一个真实状态的封装，只要闭包存在，就可以对变量就行修改。



### 四、闭包与作用域的关系

> 闭包和作用域是强相关的，JavaScript 的作用域有一定的规则以及 javaScript 的内部运行机制。
>
> 1）javascript 引擎是如何跟踪函数执行又回到函数的位置？



#### 1、javaScript 的执行上下文跟踪函数

> 因为 JavaScript 的运行机制是基于单线程的，某个特定的时刻只能执行特定的代码，所以要通过执行上下文栈来确定函数的执行顺序。



###### ▉ 基本概念

- js 代码类型分为两种：**全局代码**，在所有函数的外部定义；**局部代码**，在函数的内部定义。

- 每个函数的执行都会在一个特定的执行上下文中。**全局执行上下文**只有一个（每个页面只有一个）；而**函数执行上下文**是每当执行一个函数时，就会先创建一个函数执行上下文。
- **注意：**this 访问函数上下文和函数执行上下文是两个不同的概念。

  ​		

###### ▉ 跟踪过程

> 1）程序开始运行只有执行上下文栈中只有全局执行上下文。
>
> 2）当调用函数的时候，当前函数就会创建一个新的执行上下文入栈，就说明当前的函数正在执行。
>
> 3）如果当前的函数执行完毕，所创建的执行上下文就会出栈，将控制权教给上一级。
>
> 4）直到所有有执行上下文出栈，全局执行上下文恢复执行。



#### 2、javascript 引擎跟踪词法环境

> 词法环境是每个（函数）执行上下文中所有变量和函数存储的环境。词法环境是 JavaScript 内部的实现机制，通常称为作用域。



###### ▉ 词法环境的作用

> 词法环境主要是 JavaScript 引擎用来**如何跟踪变量**以及如果**判断变量的可访问性**。



###### ▉ 关联性

> 词法环境与 JavaScript 的代码就够进行关联，如：函数、代码片段等是相互关联的。



#### 2.1 代码嵌套

> 词法环境主要与代码嵌套（代码嵌套的结构）相关联的，每执行代码，代码结构就会获取与之相关联的词法环境，用来确保内部环境可访问外部环境。



#### 2.2 代码嵌套与词法环境的关系

> 词法环境查询变量时，根据执行上下文对应的词法环境由内而外依次进行查找，直到查找到最外层的全局作用域。



###### ▉ 函数 - 执行上下文 - 词法环境的关系

1、每个执行上下文都对应一个词法环境（函数的局部作用域）；

2、每个局部函数中的内部属性 [[Environment]] 与创建的执行上下文相关联（所在当前函数的执行上下文）；



### 五、闭包的工作原理

#### 1、闭包模拟私有变量

> 闭包模拟 js 的私有变量时，会 new 一个实例对象，实例对象就会通过闭包获取或改变构造函数内的局部变量模拟面向对象。每次调用构造函数，都会创建一个新的词法环境，该词法环境会保持着构造函数内部的局部变量。



###### ▉ 内部实现步骤

> 1）new 一个实例对象。
>
> 2）进入构造函数，为**构造函数创建一个新的词法环境**，它始终保持着对局部变量的引用。
>
> 3）然后为空对象添加两个函数，这两个函数 [[Envrionment]] 都保持着对**新创建函数的词法环境**的引用，返回新对象。
>
> 4）当调用对象的函数时，就会创建新的执行上下文推入执行栈中，这回引起创建的新的词法环境（内部函数）。
>
> 5）js 引擎会检查当前函数的词法环境中有没有想要的变量，如果没有，则会到外部变量（构造函数的词法环境）中去查找，查找到了就返回。







