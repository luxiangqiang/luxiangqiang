---
title: 计算机网络原理之【TCP协议】
categories:
- 网络原理
tags:
- 网络原理
---

关于 TCP 的三次握手和四次挥手！

<!--more--> 



### 一、TCP 的三次握手

#### 基本概念

- `SYN：` 同步序列编号（**Synchronize Sequence Numbers**）, 是 TCP 握手的发送的第一个数据包。



#### TCP 头部详情

![img](http://static.oschina.net/uploads/space/2016/0520/140931_eg7U_2303535.png)

**1、`source port（源端口号）`和 `distination port(目的端口号)`** ：告诉注意报文字段来自哪个端口（源端口），以及要传给上层哪层协议的应用程序（目的端口号）。

- 长度 16 位

```javascript
应用程序的端口号和应用程序所在主机的 IP 地址统称为 socket（套接字），IP:端口号, 在互联网上 socket 唯一标识每一个应用程序，源端口+源IP+目的端口+目的IP称为”套接字对“，一对套接字就是一个连接，一个客户端与服务器之间的连接。
```

**2、`Sequence Number(序列号)`** : 用于 TCP 通信过程中某一传输方向上字节流的每个字节的编号，为了确保数据通信的有序性，避免网络中乱序的问题。 接收端根据这个编号进行确认，保证分割的数据段在原始数据包的位置。

- 长度 32 位
- 初始序列号由自己定，而后绪的序列号由对端的 ACK 决定：`SN_x = ACK_y` (x 的序列号 = y 发给 x 的 ACK)

**3、`Acknowledgment Number(确认序列号)`** ：确认序列号是接收确认端所期望收到的下一序列号。确认序号应当是上次已成功收到数据字节序号加1，只有当标志位中的 ACK 标志为 1 时该确认序列号的字段才有效。主要用来解决不丢包的问题。

- 长度 32 位

**4、`TCP Flags :`**TCP 首部中有 6 个标志比特，它们中的多个可同时被设置为 1，主要是**用于操控 TCP 的状态机**的，依次为 `URG，ACK，PSH，RST，SYN，FIN`。

- `URG`：此标志表示TCP包的紧急指针域（后面马上就要说到）有效，用来保证TCP连接不被中断，并且督促中间层设备要尽快处理这些数据。
- **`ACK（重点）`：**此标志表示应答域有效，就是说前面所说的TCP应答号将会包含在 TCP 数据包中；有两个取值：0 和 1，为 1 的时候表示应答域有效，反之为 0；
- `PSH`: 这个标志位表示 Push 操作。所谓 Push 操作就是指在数据包到达接收端以后，立即传送给应用程序，而不是在缓冲区中排队；
- `RST` ：这个标志表示连接复位请求。用来复位那些产生错误的连接，也被用来拒绝错误和非法的数据包；
- **`SYN（重点）` ：**表示同步序列号，用来建立 TCP 的连接。SYN标志位和ACK标志位搭配使用，当连接请求的时候，SYN=1，ACK=0；连接被响应的时候，SYN=1，ACK=1；这个标志的数据包经常被用来进行端口扫描。扫描者发送一个只有SYN的数据包，如果对方主机响应了一个数据包回来 ，就表明这台主机存在这个端口；
- **`FIN（重点）` ：** 表示发送端已经达到数据末尾，也就是说双方的数据传送完成，没有数据可以传送了，发送 FIN 标志位的 TCP 数据包后，连接将被断开。这个标志的数据包也经常被用于进行端口扫描。

**5、`Window size(滑动窗口大小)`**：所说的滑动窗口，用来进行流量控制。



#### 1.1 握手作用

> 1、为了确认双方的接收与发送能力是否正常。
>
> 2、指定自己的初始化序列号，为后面的可靠传送做准备。
>
> 3、如果是 https 协议的话，三次握手这个过程，还会进行数字证书的验证以及加密密钥的生成到。



#### 1.2 握手过程

**1、初始状态：**客户端处于 `closed` 状态，服务器处于 `listen` 状态。

**2、第一次握手：**客户端给服务端发送一个 `SYN` （并置为 1）报文，并指明客户端的初始化序列号 `ISN(c)`。此时客户端处于 `SYN_Send` 状态。

**3、第二次握手：**服务端收到客户端的 `SYN` 报文之后，会以自己的 `SYN` 报文作为答应，并且也指定了自己的初始化序列号 `ISN(s) `,同时会把客户端的 `ISN + 1` 作为 `ACK` 的值，表示自己已经收到客户端的 `SYN `，此时服务器处于 `SYN_REVD` 的状态。

**4、第三次握手：**客户端收到 `SYN` 报文之后，会发送一个 `ACK` 报文，当然，也是一样把服务器的 `ISN + 1` 作为 `ACK` 的值，表示已经收到了服务端的 `SYN` 报文，此时客户端处于 `establised` 状态。

**5、**服务器收到 ACK 报文之后，也处于 **establised 状态**，此时，双方以建立起了链接。

![img](https://mmbiz.qpic.cn/mmbiz_png/b95QHPkcOMBrXTMI7LNzs7drC044ibDkxSVNr37IgFeyGLstNGLp7k9Lpia5tp79lZqNYicbOJbELC4f6iaMvZ4LHw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

#### 1.3 初始化序列号(ISN) 是固定的吗？

> 1、三次握手的一个重要功能是客户端和服务端交换ISN(Initial Sequence Number), 以便让对方知道接下来接收数据的时候如何按序列号组装数据。
>
> 2、如果ISN是固定的，攻击者很容易猜出后续的确认号，因此 ISN 是动态生成的。



#### 1.4 什么是半连接队列

> 服务器第一次收到客户端的 SYN 之后，就会处于 SYN_RCVD 状态，此时双方还没有完全建立其连接，服务器会把此种状态下请求连接放在一个队列里，我们把这种队列称之为**半连接队列**。当然还有一个**全连接队列**，就是已经完成三次握手，建立起连接的就会放在全连接队列中。如果队列满了就有可能会出现丢包现象。



#### 1.5 三次握手过程中可以携带数据吗？

> 第一次、第二次不可以携带数据的，第三次握手是可以携带数据的。

原因：

> 1、因为第一次握手可以携带数据的话，攻击者就会在 SYN 的报文中放入大量的数据，攻击者不会理会服务器的接受、发送能力，所以疯狂的发送 SYN 报文，导致服务器花很长时间、内存空间来接受这些报文，如果第一次握手可以放数据的话，第一个原因就是让服务器更加容易受到攻击。
>
> 2、对于第三次握手，此时客户端已经处于 established 状态，也就是说，对于客户端来说，他已经建立起连接了，并且也已经知道服务器的接收、发送能力是正常的了。



#### 1.6 HTTPS 的认证过程

> 



### 二、TCP 的四次挥手

#### 四次挥手过程

**1、初始化状态：**刚开始双方都处于 establised 状态，客户端发起关闭请求。

**2、第一次挥手：**客户端发送一个 FIN 报文，报文中会指定一个序列号。此时客户端处于**CLOSED_WAIT1**状态。

**3、第二次挥手：**服务端收到 FIN 之后，会发送 ACK 报文，且把客户端的序列号值 + 1 作为 ACK 报文的序列号值，表明已经收到客户端的报文了，此时服务端处于 **CLOSE_WAIT2**状态。

**4、第三次挥手：**如果服务端也想断开连接了，和客户端的第一次挥手一样，发给 FIN 报文，且指定一个序列号。此时服务端处于 **LAST_ACK** 的状态。

**5、第四次挥手：**号值，此时客户端处于 **TIME_WAIT** 状态。需要过一阵子以确保服务端收到自己的 ACK 报文之后才会进入 CLOSED 状态。

**6、**服务端收到 ACK 报文之后，就处于关闭连接了，处于 CLOSED 状态。

![img](https://mmbiz.qpic.cn/mmbiz_png/b95QHPkcOMBrXTMI7LNzs7drC044ibDkx4dVUR45eKUWFj6daic3kxbFa5UiaeUM9V3Aaia6PHZ8VRWVQMj5rj1z0g/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

#### TIME_WAIT 状态

> 1、为什么客户端发送 ACK 之后不直接关闭，而是要等一阵子才关闭。这其中的原因就是，要确保服务器是否已经收到了我们的 ACK 报文，如果没有收到的话，服务器会重新发 FIN 报文给客户端，客户端再次收到 FIN 报文之后，就知道之前的 ACK 报文丢失了，然后再次发送 ACK 报文。
>
> 2、至于 TIME_WAIT 持续的时间至少是一个报文的来回时间。一般会设置一个计时，如果过了这个计时没有再次收到 FIN 报文，则代表对方成功就是 ACK 报文，此时处于 CLOSED 状态。







