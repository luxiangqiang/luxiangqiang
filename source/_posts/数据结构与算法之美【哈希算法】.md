---
title: 数据结构与算法之美【哈希算法】
categories:
- 数据结构
tags:
- 数据结构
copyright: true
---

如何防止数据库中的用户信息被脱库？

<!--more-->



## 一、哈希基本常识

### 1、什么是哈希算法？

> 将**任意长度**的二进制串映射为**固定长度**的二进制串，这个映射规则就是哈希算法。从原始数据映射之后的二进制串就是**哈希值**。



### 2、哈希算法满足的条件？

> 1）从哈希值**不能反向推导**出原始数据（单向哈希算法）；
>
> 2）对原始**数据敏感**，哪怕只改了一个bit，得到的哈希值大不形同；
>
> 3）**散列冲突**的概率要小，对于不同原始的数据，哈希值相同的概率非常小；
>
> 4）哈希算法执行效率要高效，对于较长的文本，也能快速的计算出哈希值。



### 3、实际用途（MD5 算法）

> MD5 的哈希值是 128 位的 Bit 长度，为了方便表示转化成了 16 进制编码。

```
MD5(" 我今天讲哈希算法！") = 425f0d5a917188d2c3c3dc85b5e4f2cb
MD5(" 我今天讲哈希算法 ") = a1fb91ac128e6aa37fe42c663971ac3d
```



## 二、哈希算法最常见的七大应用

> 安全加密、唯一标识、数据校验、散列函数、负载均衡、数据分片、分布式存储。



### 应用一：安全加密

> 最常用的两种加密算法 **MD5**（Message-Digest Algorithm，消息摘要算法） 加密算法和 **SHA**（Secure Hash Algorithm，安全散列算法）。



#### 1、加密的哈希特性有哪些？

###### ■ 对于加密，不能通过哈希值反向推导。

> 加密为了防止原始数据泄漏，所以很难通过哈希值反向推倒原始数据。



###### ■ 散列冲突要小 

> 无论什么哈希算法，我们只能尽量减少冲突的概率，理论上没有办法做到完全不冲突 —— 鸽巢原理（也叫抽屉原理）。



#### 2、为什么哈希无法做到零冲突？

> 哈希算法产生的哈希值长度是固定值有限的。
>
> **比如：** MD5 算法，哈希值是固定的 128 位二进制串，能表示的数据是有限的，最多能表示 2^128 个数据。而我们的原始数据是无限的，就必然会存在哈希值冲突现象。



### 应用二：唯一标识

**1、问题**

> 在海量的图库中，搜索到一张图片是否存在，最常用的解决办法就是对比图像的名称，有可能出现名称相同，图像内容不符的情况，所以应该怎么来解决？



**2、解决方法**

> 图片在计算机中的存储是以二进制码串的形式，就是用查找图片的码串和图库中的所有码串进行对比。但是由于每张图片几十 kb 转化成二进制码串非常长，怎么进行优化？



**3、方法优化**

> 给每个字符串取唯一标识，取二进制码头100字节，中间100字节，尾100字节，将这 100 字节放到一块，通过哈希算法得到一个哈希字符串当做图片的唯一标识。



**4、进一步优化**

> 通过图片的**唯一标识**和图片相应的**路径信息**都对应的存在**散列表**中。直接通过对比哈希字符串定位到图片的唯一标识，然后通过散列表得到该图片再进行比较，如果完全相同，说明存在该图片，如果不相同，就说明存在图片名称相同，内容不同的两张图片。



### 应用三：数据校验

**1、问题**

> 基于 p2p 协议的 BT 下载软件，在多个机器并行下载，电影被分割成多块进行同步下载，然后下载完成进行整合。由于不能确定每块文件的完整性，可能被恶意篡改、下载错误等，导致最后整合无法观看，那么如何校验文件块的正确性呢？



**2、校验的哈希特性**

> 哈希算法对数据很敏感，一旦文件快内容一丁点的改变，最后的哈希值就完全不同。



**3、解决方法** 

> 用哈希算法检验下载文件块是否完整，可以对下好的文件块的哈希值与完整的文件块进行一一对比，如果不相同，就说明该文件快损坏，需要重新下载。



### 应用四：散列函数

> 散列函数也是哈希算法的一种应用。



##### 1、散列函数的哈希要求

> 1）散列函数对**散列冲突要求比较低**，只要不过于严重，通过开发**寻址法**或者**链表法**解决。
>
> 2）散列函数计算出的值**能否反向解密不关心**，反而更加关注**是否能平均分布**，也就是一组数据能否均匀的在各个槽中。
>
> 3）散列函数的快慢影响散列表的性能，所以说散列函数要求比较简单，比较追求性能。



> ## 哈希算法在分布式系统中有哪些应用？



### 应用五：负载均衡

> 负载均衡算法有很多，比如轮询、随机、加权轮询等。



##### 1、问题

> 那如何才能实现一个会话粘滞（session sticky）的负载均衡算法呢。也就是说，需要在同一个客户端上，在一次会话中的所有请求都路由到一个同一个服务器上。



##### 2、常规解决

> 维护一张映射关系表，这张表的内容是客户端 **IP 地址**或者**会话 ID** 与服**务器编号**的映射关系。客户端发出的每次请求，都要先在映射表中查找应该路由到的服务器编号，然后再请求编号对应的服务器。



##### 3、存在弊端

> 1、如果客户端很多，映射表可能会很大，比较浪费内存空间；
>
> 2、客户端下线、上线，服务器扩容、缩容都会导致映射失效，这样维护映射表的成本就会很大；



##### 4、哈希解决

> 对客户端 IP 地址或者会话 ID 计算哈希值，将取得的哈希值与服务器列表的大小进行取模运算。最终得到的值就是应该被路由到的服务器编号。就可以把同一个 IP 过来的所有请求，都路由到同一个后端服务器上。



### 应用六：数据分片

#### ▉ 示例一：如何统计“搜索关键词”出现的次数？

##### 1、问题

> 假如有 1T 的日志文件，这里面记录了用户的搜索关键词，想要快速统计出每个关键词被搜索的次数，该怎么做呢？



##### 2、思路分析

> 1） 搜索日志很大，没办法放到一台机器的内存中。
>
> 2）如果只用一台机器来处理这么巨大的数据，处理时间会很长。



##### 3、解决办法

> **MapReduce ** 的基本设计思想，先进行数据分片，然后采用多台机器的方法处理，来提高处理效率。
>
> 1）从搜索记录的日志文件中，依次读出每个搜索关键词。
>
> 2）并且通过哈希函数计算哈希值，然后再跟 n 取模。
>
> 3）  最终得到的值，就是应该被分配到的机器编号。



##### 4、条件限制

> 有另一种方法可以解决，用到散列表，详细章节情跳转：[《堆》的求前 k 大搜索关键词求所有关键字的次数。 ]()



#### ▉ 示例二：如何快速判断图片是否在图库中？ 

##### 1、问题

> 假设现在我们的图库中有 1 亿张图片，如何快速判断图片是否在图库中？



##### 2、思路分析

> 1）在单台机器上构建散列表是行不通的。因为单台机器的内存有限，而 1 亿张图片构建散列表显然远远超过了单台机器的内存上限。
>
> 2）用多台机器进行计算。



##### 3、解决

> 当判断一个图片是否在图库中的时候，用同样的哈希算法，计算唯一标识，然后与机器个数n求余取模。假设得到的值是k，那就去标号k的机器构建的散列表中查。



### 应用七：分布式存储

##### 1、问题

> 当拥有海量的用户和数据的时候，为了提高数据的读写、写入能力，一般采用分布式来存储数据。



##### 2、思想

> 利用数据分片思想，通过计算哈希算法，对数据去哈希值，然后对机器的个数进行取余，最终的就是存储缓存机器的标号。



##### 3、数据太大如何扩容？

> 变化最大就是机器的数量增加了，导致取模使得哈希值变化很大。



##### 4、导致问题

> 1）进行大规模数据迁移，所有的数据都要进行重新计算哈希值，重新搬移到正确的机器上。
>
> 2）当量的数据在缓存中就失效了，所有的数据请求都会穿透缓存，直接去请求数据库。会发生雪崩效应，压垮数据库。



##### 5、解决方法

> 假设有k个机器，数据的哈希值范围是【0，MAX】。我们将整个范围划分为m个小区间（m远大于k），
>
> 每个机器负责m/k个小区间。当有新机器加入的时候，我们在几个小区间里搬移数据到新机器中，即不用重
>
> 搬移数据，又保持了各个机器上数据的均衡。



### 三、本节思考：如何防止数据库的用户信息被脱库？

> 安全和攻击是一种博弈关系，不存在绝对的安全。所有的安全措施，只是增加了攻击的成本而已。



##### ■ 问题

> 用户的密码通过哈希算法都能转化成哈希值，所有的用户信息形成一个数据字典，一旦数据字典被攻击，黑客就会拿到加密后的密文之后和数据字典中的数据进行比对，一般对比相同的就是数据字典中的明文。



##### ■ 优化

> 引入一个盐（salt）概念，跟用户的密码进行组合到一起，增加密码的复杂度，拿到组合后的字符串进行哈希加密，将它存储到数据库，进一步增加破解的难度。



## 四、扩展思考

##### ▉ 问题：

> 区块链是怎么用哈希算法进行解决问题的？



##### ▉ 区块链的组成

> 区块链分为区块头和区块体。区块头保存着自己区块体和上一区块头的哈希值。



##### ▉ 区块链的哈希特性

> **唯一性：**链式关系用到了哈希值的唯一性，只要区块链上任意一个区块被修改过，后面所有区块保存的哈希值就不对了。 



##### ▉ 区块链的算法

> 区块链使用的是 **SHA256 哈希算法**，计算哈希值非常耗时，如果要篡改一个区块，就必须重新计算该区块后面所有的区块的哈希值，短时间内几乎不可能做到。 



































